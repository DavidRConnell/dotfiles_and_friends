#!/usr/bin/env bash
#
# Personal backup script for use with restic.
# Assumes backup drive is labeled "backup".

user=$(whoami)
export RESTIC_PASSWORD_COMMAND="sudo -Eu ${user} bash -c \"$RESTIC_PASSWORD_COMMAND\""

usage() {
    echo ""
    echo "Usage: $(basename $0) backup device"
    echo "Backups to drive with label \"backup\"."
    echo "example: $(basename $0)"
}

if [[ "$#" -eq 1 ]] && [[ "$1" = "-h" ]]; then
    usage
    exit 0
fi

partition=/dev/disk/by-label/backup
if ! [ -L $partition ]; then
    echo "Error: partition \"$partition\" not found"
    exit 1
fi

home_dir=/home/voidee
partition=$(readlink $partition)
partition=/dev/${partition/*\//}
dev=${partition//[0-9]/}
mount_point=/run/media/backup
excludes_file=$home_dir/.config/restic/excludes.txt
host=thevoidII # Since want to keep machines in sync always have same host

[[ -d $mount_point ]] || sudo mkdir -p $mount_point
mountpoint -q $mount_point || sudo mount $partition $mount_point
sudo restic -r $mount_point/TheVoidII backup $home_dir \
    --exclude-file=$excludes_file \
    --host=$host
sudo umount $mount_point
udisksctl power-off -b $dev
